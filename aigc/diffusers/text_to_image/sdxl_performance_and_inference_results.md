# Stable Diffusion XL text-to-image fine-tuning

## Requirements

| mindspore  | ascend driver  |  firmware   |cann toolkit/kernel |
|:----------:|:--------------:|:-----------:|:------------------:|
|   2.3.1    |    24.1.RC2    | 7.3.0.1.231 |   8.0.RC2.beta1    |

## Training

Experiments are tested on ascend 910* graph mode with a single card.

|  task   | batch size | train text encoder | resolution | precision | graph compile | step time(ms) | train. imgs/s |
|:-------:|:----------:|:------------------:|:----------:|:---------:|:-------------:|:-------------:|:-------------:|
| vanilla |     1      |        OFF         |  512x512   |   fp16    |   1~5 mins    |     1560      |     0.64      |
|  lora   |     1      |        OFF         | 1024x1024  |   fp16    |  10~15 mins   |      982      |     1.02      |
|  lora   |     1      |         ON         | 1024x1024  |   fp32    |  10~15 mins   |     1341      |     0.75      |

## Inference

```python
from mindone.diffusers import DiffusionPipeline
import mindspore

model_path = "stabilityai/stable-diffusion-xl-base-1.0"
pipe = DiffusionPipeline.from_pretrained(model_path, mindspore_dtype=mindspore.float16)

prompt = "The boy rides a horse in space"
image = pipe(prompt, num_inference_steps=30, guidance_scale=7.5)[0][0]
image.save("The-boy-rides-a-horse-in-space.png")
```

To change the pipelines scheduler, use the from_config() method to load a different scheduler's pipeline.scheduler.config into the pipeline.

```python
from mindone.diffusers import EulerAncestralDiscreteScheduler

pipe.scheduler = EulerAncestralDiscreteScheduler.from_config(pipeline.scheduler.config)
image = pipe(prompt, num_inference_steps=30, guidance_scale=7.5)[0][0]
image.save("The-boy-rides-a-horse-in-space.png")
```

Here are some images generated by inference under different Schedulers.

|                                                                   DDIMParallelScheduler <br/>(0.86s/step)                                                                    |                                                                    DDIMScheduler <br/>(0.8s/step)                                                                    |                                                                   LMSDiscreteScheduler <br/>(0.93s/step)                                                                    |                                                                   DPMSolverSinglestepScheduler <br/>(0.83s/step)                                                                    |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DDIMParallelScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DDIMScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/LMSDiscreteScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DPMSolverSinglestepScheduler.png?raw=true" width=224> |

### Vanilla Fine-tuning

The training details are recorded [here](https://github.com/mindspore-lab/mindone/blob/master/examples/diffusers/text_to_image/README_sdxl.md#training), we trained 6k steps based on the [OnePiece dataset](https://huggingface.co/datasets/YaYaB/onepiece-blip-captions) and here are some of results:

|                                              a man in a blue suit and a green hat                                                                                                  |                                         a man with a big mouth                                                                                              |                                                                  a man with glasses on his face                                                                     |                                                                  a man with red hair and a cape                                                                     |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_in_a_blue_suit_and_a_green_hat.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_a_big_mouth.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_glasses_on_his_face.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_red_hair_and_a_cape.png" width=224> |

### LoRA Fine-tuning the text encoder and UNet

The training details are recorded [here](https://github.com/mindspore-lab/mindone/blob/master/examples/diffusers/text_to_image/README_sdxl.md#finetuning-the-text-encoder-and-unet), we trained 6k steps based on the [OnePiece dataset](https://huggingface.co/datasets/YaYaB/onepiece-blip-captions) and here are some of results:

|                                                                       a cartoon character with a sword                                                                       |                                                                  a girl with a mask on her face                                                                   |                                                                  a guy with green hair                                                                   |                                                                  a lion sitting on the ground                                                                   |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_cartoon_character_with_a_sword.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_girl_with_a_mask_on_her_face.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_guy_with_green_hair.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_lion_sitting_on_the_ground.png" width=224> |

|                                                                  a man holding a book                                                                   |                                                                  a man in a cowboy hat                                                                   |                                                                  a man in a hat and jacket                                                                   |                                                                  a man in a yellow coat                                                                   |
|:-------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_holding_a_book.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_cowboy_hat.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_hat_and_jacket.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_yellow_coat.png" width=224> |