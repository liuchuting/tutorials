# Stable Diffusion XL text-to-image fine-tuning

## Running locally with MindSpore

| Ascend | MindSpore Version                                   | CANN Version                                                                                                      |
|--------|-----------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
| 910*   | [MS 2.3.0](https://www.mindspore.cn/versions#2.3.0) | [CANN 8.0.RC2.beta1](https://www.hiascend.com/developer/download/community/result?module=cann&cann=8.0.RC2.beta1) |

**Note**: You can use `cat /usr/local/Ascend/ascend-toolkit/latest/version.cfg` check the CANN version and you can see the specific version number `[7.3.0.1.231:8.0.RC2]`. If you have a custom installation path for CANN, find the `version.cfg` in your own CANN installation path to verify the version.

## Training

We trained on the [OnePiece dataset](https://huggingface.co/datasets/YaYaB/onepiece-blip-captions) and recorded the training speed as follows.

| Method  | NPUs | Global <br/>Batch size | Train text encoder | Resolution   | Precision | Graph Compile | Speed <br/>(ms/step) | FPS <br/>(img/s) |
|---------|------|------------------------|--------------------|--------------|-----------|---------------|----------------------|------------------|
| Vanilla | 1    | 1*1                    | FALSE              | 512x512      | FP16      | 1~5 min       | 720                  | 1.39             |
| Vanilla | 8    | 1*8                    | FALSE              | 512x512      | FP16      | 1~5 min       | 1148                 | 6.97             |
| LoRA    | 1    | 1*1                    | FALSE              | 1024x1024    | FP16      | 15~20 min     | 828                  | 1.21             |
| LoRA    | 8    | 1*8                    | FALSE              | 1024x1024    | FP16      | 15~20 min     | 907                  | 8.82             |
| LoRA    | 1    | 1*1                    | TRUE               | 1024x1024    | FP16      | 15~20 min     | 951                  | 1.05             |
| LoRA    | 1    | 1*1                    | TRUE               | 1024x1024    | BF16      | 15~20 min     | 994                  | 1.01             |
| LoRA    | 1    | 1*1                    | TRUE               | 1024x1024    | FP32      | 15~20 min     | 1890                 | 0.53             |

## Inference

```python
from mindone.diffusers import DiffusionPipeline
import mindspore

model_path = "stabilityai/stable-diffusion-xl-base-1.0"
pipe = DiffusionPipeline.from_pretrained(model_path, mindspore_dtype=mindspore.float16)

prompt = "The boy rides a horse in space"
image = pipe(prompt, num_inference_steps=30, guidance_scale=7.5)[0][0]
image.save("The-boy-rides-a-horse-in-space.png")
```

To change the pipelines scheduler, use the from_config() method to load a different scheduler's pipeline.scheduler.config into the pipeline.

```python
from mindone.diffusers import EulerAncestralDiscreteScheduler

pipe.scheduler = EulerAncestralDiscreteScheduler.from_config(pipeline.scheduler.config)
image = pipe(prompt, num_inference_steps=30, guidance_scale=7.5)[0][0]
image.save("The-boy-rides-a-horse-in-space.png")
```

Here are some images generated by inference under different Schedulers.

|                                                                   DDIMParallelScheduler <br/>(0.86s/step)                                                                    |                                                                    DDIMScheduler <br/>(0.8s/step)                                                                    |                                                                   LMSDiscreteScheduler <br/>(0.93s/step)                                                                    |                                                                   DPMSolverSinglestepScheduler <br/>(0.83s/step)                                                                    |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DDIMParallelScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DDIMScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/LMSDiscreteScheduler.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/diff_schedulers_infer/DPMSolverSinglestepScheduler.png?raw=true" width=224> |

### Vanilla Fine-tuning

We trained 10k steps based on the [OnePiece dataset](https://huggingface.co/datasets/YaYaB/onepiece-blip-captions). Here are some of the results of the fine-tuning and the training details are recorded [here](https://github.com/liuchuting/mindone/blob/sd_doc/examples/diffusers/text_to_image/README_sdxl.md#training).

|                                              a man in a blue suit and a green hat                                                                                                  |                                         a man with a big mouth                                                                                              |                                                                  a man with glasses on his face                                                                     |                                                                  a man with red hair and a cape                                                                     |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_in_a_blue_suit_and_a_green_hat.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_a_big_mouth.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_glasses_on_his_face.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_infer_fa_10k/a_man_with_red_hair_and_a_cape.png" width=224> |

### LoRA Fine-tuning the text encoder and UNet

We trained 8.5k steps based on the [OnePiece dataset](https://huggingface.co/datasets/YaYaB/onepiece-blip-captions). Here are some of the results of the lora fine-tuning and the training details are recorded [here](https://github.com/liuchuting/mindone/blob/sd_doc/examples/diffusers/text_to_image/README_sdxl.md#finetuning-the-text-encoder-and-unet).

|                                                                       a cartoon character with a sword                                                                       |                                                                  a girl with a mask on her face                                                                   |                                                                  a guy with green hair                                                                   |                                                                  a lion sitting on the ground                                                                   |
|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_cartoon_character_with_a_sword.png?raw=true" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_girl_with_a_mask_on_her_face.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_guy_with_green_hair.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_lion_sitting_on_the_ground.png" width=224> |

|                                                                  a man holding a book                                                                   |                                                                  a man in a cowboy hat                                                                   |                                                                  a man in a hat and jacket                                                                   |                                                                  a man in a yellow coat                                                                   |
|:-------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_holding_a_book.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_cowboy_hat.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_hat_and_jacket.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_in_a_yellow_coat.png" width=224> |

|                                                                  a man sitting in a chair                                                                   |                                                                  a man with a big beard                                                                   |                                                                  a man with green hair and a white shirt                                                                   |                                                                  a smiling woman in a helmet                                                                   |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_sitting_in_a_chair.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_with_a_big_beard.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_man_with_green_hair_and_a_white_shirt.png" width=224> | <img src="https://github.com/liuchuting/mindone/blob/image/examples/diffusers/text_to_image/images/sdxl_lora_infer/a_smiling_woman_in_a_helmet.png" width=224> |
